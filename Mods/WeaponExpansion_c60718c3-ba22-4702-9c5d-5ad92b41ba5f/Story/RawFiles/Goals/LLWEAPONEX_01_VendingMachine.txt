Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_DoNotFace((CHARACTERGUID)CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a);
DB_Dialogs(CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LLWEAPONEX_VendingMachine_A");
DB_BlockThreatenedDialog(CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a);
DB_NoLowAttitudeDialog(CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a);
CharacterDisableAllCrimes(CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a);
SetCanJoinCombat(CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, 0);
//DB_IsStoryNpc(CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a);
//SetStoryNpc(CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, 1);
SetTag(CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LeaderLib_DisableTreasureTableLimit");
LLWEAPONEX_VendingMachine_RegisterTraderSettings();
LLWEAPONEX_VendingMachine_RegisterOrderMenu();

KBSECTION
//REGION SETTINGS_TRADER
PROC
LLWEAPONEX_VendingMachine_RegisterTraderSettings()
THEN
LeaderLib_Trader_Register_GlobalTrader("LLWEAPONEX.VendingMachine", CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a);
//LeaderLib_Trader_Register_Dialog("LLWEAPONEX.VendingMachine", "LLWEAPONEX_VendingMachine_A");

LeaderLib_Treasure_Register_TreasureToTrader("LLWEAPONEX.VendingMachine.Orders", "LLWEAPONEX.VendingMachine");
LeaderLib_Treasure_Register_TreasureToTrader("LLWEAPONEX.VendingMachine.Uniques", "LLWEAPONEX.VendingMachine");

LeaderLib_Treasure_Configure_DefaultGenerationType("LLWEAPONEX.VendingMachine.Uniques", "REQUIREMENT_UNLOCKED");
LeaderLib_Treasure_Configure_DefaultGenerationType("LLWEAPONEX.VendingMachine.Uniques", "TRADE_GENERATION_END");

LeaderLib_Requirements_Add_PartyLevelRequirement("LLWEAPONEX_Requirement_MinLevel_4", 4);
LeaderLib_Requirements_Add_ModRequirement("LLWEAPONEX_Requirement_MimicryModActive", "Mimicry", "LaughingLeader");

//Technically unique, but allow more than one to generate
LeaderLib_Treasure_Register_ItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "TOOL_Hammer_LLWEAPONEX_Runesmith_A_5a5e78fb-59ac-42b8-8e2f-d4d02f9217ec", 1, "LLWEAPONEX_Requirement_MinLevel_4");
LeaderLib_Treasure_Configure_AddMaxAmount("LLWEAPONEX.VendingMachine.Uniques", "TOOL_Hammer_LLWEAPONEX_Runesmith_A_5a5e78fb-59ac-42b8-8e2f-d4d02f9217ec", 1);

LLWEAPONEX_VendingMachine_RegisterUniqueWeapons();

LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "WPN_LLWEAPONEX_Throwing_Rock_Unique_Kevin_b3fc8995-8c7c-4de5-b465-e2573334cff7");

LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "EQ_Clothing_UNIQUE_LLWEAPONEX_Blindfolds_Monk_A_78b08f39-3d9d-47b5-b251-f1b8dcebe65b");


LeaderLib_Trader_Register_Position("LLWEAPONEX.VendingMachine", "TestLevel_LL_WeaponExpansion", 40.56, 0.0, 29.63);
LeaderLib_Trader_Register_Rotation_Position("LLWEAPONEX.VendingMachine", "FJ_FortJoy_Main", 40.56, 0.0, 29.63);
//LeaderLib_Trader_Register_Position("LLWEAPONEX.VendingMachine", "TUT_Tutorial_A", 31.19, 4.0, -252.77);

//Dungeon Shrine in Fort Joy
LeaderLib_Trader_Register_Position("LLWEAPONEX.VendingMachine", "FJ_FortJoy_Main", 196.21, -3.98, 647.16);
LeaderLib_Trader_Register_Rotation_Position("LLWEAPONEX.VendingMachine", "FJ_FortJoy_Main", 204.38, -4.57, 649.32);

//Lady Vengeance 1st floor
LeaderLib_Trader_Register_Position("LLWEAPONEX.VendingMachine", "LV_HoE_Main", 336.39, 7.8, 577.70);
LeaderLib_Trader_Register_Rotation_Position("LLWEAPONEX.VendingMachine", "LV_HoE_Main", 336.39, 7.8, 579.0);

//Lady Vengeance 1st floor
LeaderLib_Trader_Register_Position("LLWEAPONEX.VendingMachine", "RC_Main", 740.56, 8.11, -41.46);
LeaderLib_Trader_Register_Rotation_Position("LLWEAPONEX.VendingMachine", "RC_Main", 740.56, 8.11, -40.22);

//Lady Vengeance 1st floor
LeaderLib_Trader_Register_Position("LLWEAPONEX.VendingMachine", "CoS_Main", 228.84, 16.09, 284.24);
LeaderLib_Trader_Register_Rotation_Position("LLWEAPONEX.VendingMachine", "CoS_Main", 226.68, 16.09, 284.24);

//Outside
LeaderLib_Trader_Register_Position("LLWEAPONEX.VendingMachine", "Arx_Main", 407.41, 39.19, 14.01);
LeaderLib_Trader_Register_Rotation_Position("LLWEAPONEX.VendingMachine", "Arx_Main", 409.22, 39.19, 13.19);

PROC
LLWEAPONEX_VendingMachine_RegisterUniqueWeapons()
THEN
LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "WPN_UNIQUE_LLWEAPONEX_Quarterstaff_Spear_2H_PowerPole_3a40634d-b4c3-482a-9f24-c5e93b336d6a");

LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "WPN_UNIQUE_LLWEAPONEX_Katana_Dagger_Sword_2H_Muramasa_4be8ec78-17ed-4f61-b3d8-96c260d1c80a");
LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "WPN_UNIQUE_LLWEAPONEX_Katana_Dagger_Runeblade_Fire_1H_A_25726991-6bc1-45fb-a00b-d3bf855cd0d1");
LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "WPN_UNIQUE_LLWEAPONEX_Rapier_Dagger_Runeblade_Water_1H_d82bc239-4782-484c-88ab-e1fa571c9f6a");

LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "WPN_UNIQUE_LLWEAPONEX_Katana_Dagger_Sword_2H_Raizan_1_b1320940-1afb-479a-b510-875afdb12d41");
LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "LOOT_LLWEAPONEX_Orb_Thunder_A_dc34fbef-a647-4eea-a313-8ef1e859ce82");

LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "WPN_UNIQUE_LLWEAPONEX_Greatbow_Lightning_Bow_2H_A_7efec0e0-1c2e-4f0d-9ec5-e3a1f40c97b8");
LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "WPN_UNIQUE_LLWEAPONEX_Sword_2H_Parasite_A_1cc2baa1-cd58-40a3-8b53-89ef2e081616");

//Grimoires
//LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "WPN_UNIQUE_LLWEAPONEX_Grimoire_Death_3ef2d9c5-13e3-48a2-ab11-36f118ec7e67");
LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "WPN_UNIQUE_LLWEAPONEX_Grimoire_Mimicry_c9fcc947-4423-40b9-9629-ae2d1e156dfc", "LLWEAPONEX_Requirement_MimicryModActive");
LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "WPN_UNIQUE_LLWEAPONEX_Grimoire_Swap_f4227e7f-86df-498f-817c-fc00896eb040");
LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "WPN_UNIQUE_LLWEAPONEX_Grimoire_Wind_c12e4d82-a6a5-4b3b-b29d-9e7810ff3216");
LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "WPN_UNIQUE_LLWEAPONEX_Grimoire_Death_3ef2d9c5-13e3-48a2-ab11-36f118ec7e67");
//END_REGION

//REGION UPDATES
//Raizan Update
PROC
LeaderUpdater_ModUpdated("WeaponExpansion", "LaughingLeader", (STRING)_PastVersion, (STRING)_NewVersion)
AND
DB_LeaderLib_StringExt_VersionIsLessThan(_PastVersion, 0,9,4,1)
THEN
ItemTemplateAddTo("WPN_UNIQUE_LLWEAPONEX_Katana_Dagger_Sword_2H_Raizan_1_b1320940-1afb-479a-b510-875afdb12d41", S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, 1, 0);
ItemTemplateAddTo("LOOT_LLWEAPONEX_Orb_Thunder_A_dc34fbef-a647-4eea-a313-8ef1e859ce82", S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, 1, 0);
LLWEAPONEX_VendingMachine_RegisterUniqueWeapons();

PROC
LeaderUpdater_ModUpdated("WeaponExpansion", "LaughingLeader", (STRING)_PastVersion, (STRING)_NewVersion)
AND
DB_LeaderLib_StringExt_VersionIsLessThan(_PastVersion, 0, 9, 3, 3)
THEN
LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "WPN_UNIQUE_LLWEAPONEX_Greatbow_Lightning_Bow_2H_A_7efec0e0-1c2e-4f0d-9ec5-e3a1f40c97b8");
//END_REGION

//REGION SETTINGS_ORDER_MENU
PROC
LLWEAPONEX_VendingMachine_RegisterOrderMenu()
THEN
//Vending Machine Order Menu
LeaderLib_DynamicMenu_Register_Menu("LLWEAPONEX.VendingMachine.OrderMenu", 8);
LeaderLib_DynamicMenu_Register_Dialog("LLWEAPONEX.VendingMachine.OrderMenu", "LLWEAPONEX_VendingMachine_OrderMenu");
LeaderLib_DynamicMenu_Register_PageFlags("LLWEAPONEX.VendingMachine.OrderMenu", "LLWEAPONEX_VendingMachine_HasMultiplePages", "LLWEAPONEX_VendingMachine_NextPage", "LLWEAPONEX_VendingMachine_PreviousPage", "LLWEAPONEX_VendingMachine_FirstPage", "LLWEAPONEX_VendingMachine_LastPage");

LeaderLib_DynamicMenu_Register_Variable("LLWEAPONEX.VendingMachine.OrderMenu", "LLWEAPONEX_VendingMachine_OrderOption1_01202c05-bdbb-42c2-9cda-8346962041d5", "LLWEAPONEX_VendingMachine_Option1Available", "LLWEAPONEX_VendingMachine_OrderOption1"); 
LeaderLib_DynamicMenu_Register_Variable("LLWEAPONEX.VendingMachine.OrderMenu", "LLWEAPONEX_VendingMachine_OrderOption2_1af35687-3367-4206-8aa4-debee4b81d92", "LLWEAPONEX_VendingMachine_Option2Available", "LLWEAPONEX_VendingMachine_OrderOption2"); 
LeaderLib_DynamicMenu_Register_Variable("LLWEAPONEX.VendingMachine.OrderMenu", "LLWEAPONEX_VendingMachine_OrderOption3_048eaa1b-d937-48bb-ac2c-5759cd64540f", "LLWEAPONEX_VendingMachine_Option3Available", "LLWEAPONEX_VendingMachine_OrderOption3"); 
LeaderLib_DynamicMenu_Register_Variable("LLWEAPONEX.VendingMachine.OrderMenu", "LLWEAPONEX_VendingMachine_OrderOption4_33af56c3-1b27-4867-9f71-ec84fc3a2fb4", "LLWEAPONEX_VendingMachine_Option4Available", "LLWEAPONEX_VendingMachine_OrderOption4"); 
LeaderLib_DynamicMenu_Register_Variable("LLWEAPONEX.VendingMachine.OrderMenu", "LLWEAPONEX_VendingMachine_OrderOption5_6304637d-2828-45ec-b01d-d4769787a29b", "LLWEAPONEX_VendingMachine_Option5Available", "LLWEAPONEX_VendingMachine_OrderOption5"); 
LeaderLib_DynamicMenu_Register_Variable("LLWEAPONEX.VendingMachine.OrderMenu", "LLWEAPONEX_VendingMachine_OrderOption6_d70c702c-a0c1-49a7-8772-1479725e2a39", "LLWEAPONEX_VendingMachine_Option6Available", "LLWEAPONEX_VendingMachine_OrderOption6"); 
LeaderLib_DynamicMenu_Register_Variable("LLWEAPONEX.VendingMachine.OrderMenu", "LLWEAPONEX_VendingMachine_OrderOption7_5027bce6-f787-4977-a23c-a09175f02508", "LLWEAPONEX_VendingMachine_Option7Available", "LLWEAPONEX_VendingMachine_OrderOption7"); 
LeaderLib_DynamicMenu_Register_Variable("LLWEAPONEX.VendingMachine.OrderMenu", "LLWEAPONEX_VendingMachine_OrderOption8_643f5348-d324-4508-ace3-71505bb30dee", "LLWEAPONEX_VendingMachine_Option8Available", "LLWEAPONEX_VendingMachine_OrderOption8");

//Vanilla
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_LLWEAPONEX_VendingMachine_OrderAccessory", "*[ACCESSORY] Click on the button labeled 'Accessory'.*");

LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_LLWEAPONEX_VendingMachine_OrderArmor", "*[ANY ARMOR] Click on the button labeled 'Any Armor'.*");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_LLWEAPONEX_VendingMachine_OrderClothArmor", "*[CLOTH ARMOR] Click on the button labeled 'Cloth Armor'.*");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_LLWEAPONEX_VendingMachine_OrderHeavyArmor", "*[HEAVY ARMOR] Click on the button labeled 'Heavy Armor'.*");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_LLWEAPONEX_VendingMachine_OrderLightArmor", "*[LIGHT ARMOR] Click on the button labeled 'Light Armor'.*");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_LLWEAPONEX_VendingMachine_OrderMageArmor", "*[MAGE ARMOR] Click on the button labeled 'Mage Armor'.*");

LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_LLWEAPONEX_VendingMachine_OrderWeapon", "*[ANY WEAPON] Click on the button labeled 'Any Weapon'.*");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_LLWEAPONEX_VendingMachine_OrderOneHandedWeapon", "*[ONE-HANDED] Click on the button labeled 'One-Handed'.*");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_LLWEAPONEX_VendingMachine_OrderTwoHandedWeapon", "*[TWO-HANDED] Click on the button labeled 'Two-Handed'.*");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_LLWEAPONEX_VendingMachine_OrderRangedWeapon", "*[RANGED] Click on the button labeled 'Ranged'.*");

LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_LLWEAPONEX_VendingMachine_OrderStaff", "*[STAFFS] Click on the button labeled 'Staffs'.*");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_LLWEAPONEX_VendingMachine_OrderWand", "*[WANDS] Click on the button labeled 'Wands'.*");

//LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_Trader_WeaponArcher", "*[ARCHER WEAPON] Click on the button labeled 'Archer Weapons'.*");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_LLWEAPONEX_VendingMachine_OrderRogueWeapon", "*[ROGUE WEAPONS] Click on the button labeled 'Rogue Weapons'.*");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_LLWEAPONEX_VendingMachine_OrderWarriorWeapon", "*[WARRIOR WEAPONS] Click on the button labeled 'Warrior Weapons'.*");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_LLWEAPONEX_VendingMachine_OrderWizardWeapon", "*[WIZARD WEAPONS] Click on the button labeled 'Wizard Weapons'.*");

LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_AllPotions", "*[POTIONS] Click on the button labeled 'Potions'.*");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_AllPotionsSpecial", "*[S. POTIONS] Click on the button labeled 'Special Potions'.*");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_Ingredients", "*[INGREDIENTS] Click on the button labeled 'Ingredients'.*");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_Grenades", "*[GRENADES] Click on the button labeled 'Grenades'.*");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_Arrows", "*[ARROWS] Click on the button labeled 'Arrows'.*");

PROC
LLWEAPONEX_VendingMachine_AddOrderToMenu((STRING)_TreasureTable, (STRING)_EntryText)
THEN
LeaderLib_DynamicMenu_Register_Entry("LLWEAPONEX.VendingMachine.OrderMenu", _TreasureTable, _EntryText);
//END_REGION

//REGION ORDER_MENU
/*
IF
DialogStarted("LLWEAPONEX_VendingMachine_OrderMenu", _Instance)
THEN
LeaderLib_DynamicMenu_InitMenu("LLWEAPONEX.VendingMachine.OrderMenu", _Instance);
*/

PROC
LeaderLib_DynamicMenu_OnEntryValueSet((GUIDSTRING)_Player, "LLWEAPONEX.VendingMachine.OrderMenu", (STRING)_DialogVar, (STRING)_AvailableFlag, (INTEGER)_Instance, (STRING)_TreasureTable, (STRING)_DisplayText)
AND
DB_LLWEAPONEX_VendingMachine_LastOrdered(_TreasureTable, _LastInstance)
THEN
ObjectClearFlag(_Player, _AvailableFlag, _Instance);

PROC
LeaderLib_DynamicMenu_OnEntrySelected("LLWEAPONEX.VendingMachine.OrderMenu", (GUIDSTRING)_Player, (INTEGER)_Instance, (STRING)_TreasureTable)
THEN
LeaderLog_Log("DEBUG", "[LLWEAPONEX:VendingMachine:OnEntrySelected] Entry [",_TreasureTable,"] was selected.");
LLWEAPONEX_VendingMachine_OrderTreasure(_Player, _TreasureTable, _Instance);

PROC
LLWEAPONEX_VendingMachine_OrderTreasure((GUIDSTRING)_Player, (STRING)_TreasureTable, (INTEGER)_Instance)
AND
NOT DB_LLWEAPONEX_VendingMachine_LastOrdered(_TreasureTable, _)
THEN
LeaderLog_Log("DEBUG", "[LLWEAPONEX:VendingMachine:OrderTreasure] Setting next order to [",_TreasureTable,"].");
DB_LLWEAPONEX_VendingMachine_NextOrder(_TreasureTable, _Instance);
ObjectSetFlag(_Player, "LLWEAPONEX_VendingMachine_OrderChosen", _Instance);

IF
ObjectFlagSet("LLWEAPONEX_VendingMachine_CompleteOrder", _Player, _Instance)
AND
DB_LLWEAPONEX_VendingMachine_LastOrdered(_LastTreasureTable, _LastInstance)
THEN
NOT DB_LLWEAPONEX_VendingMachine_LastOrdered(_LastTreasureTable, _LastInstance);

IF
ObjectFlagSet("LLWEAPONEX_VendingMachine_CompleteOrder", _Player, _Instance)
AND
LeaderLib_Helper_QRY_ClearObjectFlag(_Player, "LLWEAPONEX_VendingMachine_CompleteOrder")
AND
DB_LLWEAPONEX_VendingMachine_NextOrder(_TreasureTable, _Instance)
AND
DialogGetInvolvedNPC(_Instance, 1, _VendingMachine)
THEN
DB_LLWEAPONEX_VendingMachine_LastOrdered(_TreasureTable, _Instance);
NOT DB_LLWEAPONEX_VendingMachine_NextOrder(_TreasureTable, _Instance);
LeaderLib_Treasure_Register_TreasureTable("LLWEAPONEX.VendingMachine.Orders", _TreasureTable);
LeaderLib_Treasure_Configure_GenerateOnce("LLWEAPONEX.VendingMachine.Orders", _TreasureTable, "LLWEAPONEX_VendingMachine_OnOrderGenerated");
ObjectSetFlag(_VendingMachine, "LLWEAPONEX_VendingMachine_OrderMenuDisabled");
LeaderLog_Log("DEBUG", "[LLWEAPONEX:VendingMachine:CompleteOrder] Added [",_TreasureTable,"] as the next treasure order.");

IF
DialogEnded("LLWEAPONEX_VendingMachine_OrderMenu", _Instance)
AND
DialogGetInvolvedPlayer(_Instance, 1, _Player)
THEN
ObjectClearFlag(_Player, "LLWEAPONEX_VendingMachine_OrderChosen", _Instance);
ObjectClearFlag(_Player, "LLWEAPONEX_VendingMachine_CompleteOrder", _Instance);

IF
StoryEvent(_VendingMachine, "LLWEAPONEX_VendingMachine_OnOrderGenerated")
THEN
ObjectClearFlag(_VendingMachine, "LLWEAPONEX_VendingMachine_OrderMenuDisabled");
LeaderLog_Log("DEBUG", "[LLWEAPONEX:VendingMachine:OnOrderGenerated] Treasure order complete. Cleared flag 'LLWEAPONEX_VendingMachine_OrderMenuDisabled'.");
PlayEffect(_VendingMachine, "LLWEAPONEX_FX_VendingMachine_Words_OrderArrived_01", "Dummy_OverheadFX");
//END_REGION

//REGION INIT
IF
CharacterLeveledUp(_Player)
AND
DB_IsPlayer(_Player)
AND
CharacterGetLevel(_Player, _Level)
THEN
CharacterLevelUpTo(CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, _Level);

IF
CharacterLeveledUp(CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a)
THEN
TimerCancel("LLWEAPONEX_Timers_VendingMachine_LevelUpItems");
TimerLaunch("LLWEAPONEX_Timers_VendingMachine_LevelUpItems", 500);

IF
TimerFinished("LLWEAPONEX_Timers_VendingMachine_LevelUpItems")
THEN
LeaderLib_Growth_Items_LevelUpItems(CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a);

PROC
LeaderLib_Traders_OnSpawned(CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, (STRING)_TraderID, (STRING)_Region)
AND
ObjectGetFlag(CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LLWEAPONEX_Vending_Initialized", 0)
THEN
LeaderLog_Log("DEBUG", "[LLWEAPONEX:VendingMachine:OnSpawned] Initializing Vending Machine.");
ProcObjectTimer(CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LLWEAPONEX_Timers_LevelUpVendingMachine", 1000);
PROC_LoopEffect("LLWEAPONEX_VendingMachine_WeaponDisplay_Quarterstaff_01", CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LLWEAPONEX_FX_VendingMachine_WeaponDisplay_Hook", _Region, "Dummy_WeaponDisplay_Hook");
PROC_LoopEffect("LLWEAPONEX_VendingMachine_WeaponDisplay_ThrowingWeapons_01", CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LLWEAPONEX_FX_VendingMachine_WeaponDisplay_Bottom", _Region, "Dummy_WeaponDisplay_Bottom");
ObjectSetFlag(CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LLWEAPONEX_Vending_Initialized");
CharacterTransformAppearanceToWithEquipmentSet(CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LLWEAPONEX_VendingMachine_A", 0);

//Flipped bones workaround for now
//PROC_StopLoopEffect(CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LLWEAPONEX_VendingMachineWorkaroundDisplay");
//PROC_LoopEffect("LLWEAPONEX_FX_VendingMachine_MachineDisplay_Debug_01", CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LLWEAPONEX_VendingMachineWorkaroundDisplay", _Region, "");

QRY
LLWEAPONEX_VendingMachine_QRY_IsInside("LV_HoE_Main")
THEN
DB_NOOP(1);

QRY
LLWEAPONEX_VendingMachine_QRY_IsInside("RC_Main")
THEN
DB_NOOP(1);

QRY
LLWEAPONEX_VendingMachine_QRY_IsInside("CoS_Main")
THEN
DB_NOOP(1);

QRY
LLWEAPONEX_VendingMachine_QRY_IsInside("TestLevel_LL_WeaponExpansion")
THEN
DB_NOOP(1);

IF
ObjectFlagSet("LLWEAPONEX_Vending_Initialized", (CHARACTERGUID)_VendingMachine, _)
AND
DB_CurrentLevel(_Region)
AND
NOT LLWEAPONEX_VendingMachine_QRY_IsInside(_Region)
THEN
PROC_LoopEffect("LLWEAPONEX_VendingMachine_A_PipeSmoke_01", _VendingMachine, "LLWEAPONEX_FX_VendingMachine_Smoke", _Region, "Dummy_SmokeFX");

IF
ObjectFlagSet("LLWEAPONEX_Vending_Initialized", (CHARACTERGUID)_VendingMachine, _)
AND
DB_CurrentLevel(_Region)
AND
LLWEAPONEX_VendingMachine_QRY_IsInside(_Region)
THEN
PROC_LoopEffect("LLWEAPONEX_VendingMachine_A_PipeSmoke_02", _VendingMachine, "LLWEAPONEX_FX_VendingMachine_Smoke", _Region, "Dummy_SmokeFX");

PROC
ProcObjectTimerFinished((CHARACTERGUID)_VendingMachine, "LLWEAPONEX_Timers_LevelUpVendingMachine")
AND
CharacterGetHostCharacter(_Player)
AND
CharacterGetLevel(_Player, _Level)
THEN
CharacterLevelUpTo(_VendingMachine, _Level);

//Temporary workaround
/*
IF
GameStarted(_Region, _)
AND
ObjectExists(CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, 1)
AND
HasActiveStatus(CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LEADERLIB_NO_VISUAL", 0)
THEN
ApplyStatus(CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LEADERLIB_NO_VISUAL", -1.0);
*/
//END_REGION

//REGION SALE_EFFECT
IF
DialogStarted("LLWEAPONEX_VendingMachine_A", _)
AND
ObjectGetFlag(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LLWEAPONEX_VendingMachine_SaleActive", 1)
AND
ObjectGetFlag(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LLWEAPONEX_VendingMachine_PlayedSaleEffect", 0)
THEN
PlayEffect(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LLWEAPONEX_FX_VendingMachine_Words_Sale_01", "Dummy_OverheadFX");
ObjectSetFlag(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LLWEAPONEX_VendingMachine_PlayedSaleEffect", 0);

PROC
LLWEAPONEX_VendingMachine_OnSaleEnded((CHARACTERGUID)_VendingMachine)
THEN
LeaderLog_Log("DEBUG", "[LLWEAPONEX:VendingMachine:TradeGenerationEnded] Sale ended.");
LLWEAPONEX_VendingMachine_ResetSaleAttitude();
DialogSetVariableString("LLWEAPONEX_VendingMachine_A", "LLWEAPONEX_VendingMachine_SaleStatus_b12f911c-7a98-4ff1-a35c-f2127335884f", "");
ObjectClearFlag(_VendingMachine, "LLWEAPONEX_VendingMachine_PlayedSaleEffect", 0);
ObjectClearFlag(_VendingMachine, "LLWEAPONEX_VendingMachine_SaleActive", 0);

PROC
LeaderUpdater_ModUpdated("WeaponExpansion", "LaughingLeader", (STRING)_PastVersion, (STRING)_NewVersion)
AND
LeaderLib_StringExt_QRY_VersionIsLessThan(_PastVersion, 0, 9, 3, 32)
AND
DB_LLWEAPONEX_VendingMachine_SaleCooldown(-1, _CooldownTime)
THEN
DialogSetVariableString("LLWEAPONEX_VendingMachine_A", "LLWEAPONEX_VendingMachine_SaleStatus_b12f911c-7a98-4ff1-a35c-f2127335884f", "");
//END_REGION

//REGION SALES
IF
TradeGenerationEnded(CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a)
THEN
LLWEAPONEX_VendingMachine_OnTradeGenerationEnded(CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a);

PROC
LLWEAPONEX_VendingMachine_OnTradeGenerationEnded((CHARACTERGUID)_VendingMachine)
AND
NOT DB_LLWEAPONEX_VendingMachine_Temp_GenerationTickDone(_)
AND
NOT DB_LLWEAPONEX_VendingMachine_SaleCooldown(_,_)
AND
LeaderLib_Roll_QRY(60)
AND
LeaderLib_Random_QRY(5)
AND
DB_LeaderLib_Random(_CooldownTimeRan)
AND
IntegerSum(_CooldownTimeRan, 1, _CooldownTime)
AND
LeaderLib_Random_QRY(1)
AND
DB_LeaderLib_Random(_ActiveTimeRan)
AND
IntegerSum(1, _ActiveTimeRan, _ActiveTime)
AND
IntegertoString(_ActiveTime, _ActiveTimeStr)
AND
IntegertoString(_CooldownTime, _CooldownTimeStr)
THEN
NOT DB_LeaderLib_Random(_ActiveTimeRan);
LeaderLog_Log("DEBUG", "[LLWEAPONEX:VendingMachine:TradeGenerationEnded] The vending machine started a sale for [",_ActiveTimeStr,"] generation events. Cooldown: [",_CooldownTimeStr,"]");
DialogSetVariableString("LLWEAPONEX_VendingMachine_A", "LLWEAPONEX_VendingMachine_SaleStatus_b12f911c-7a98-4ff1-a35c-f2127335884f", " You see a sign that reads: 'Limited time sale now active!'");
ObjectSetFlag(_VendingMachine, "LLWEAPONEX_VendingMachine_SaleActive", 0);
DB_LLWEAPONEX_VendingMachine_SaleCooldown(_ActiveTime, _CooldownTime);
DB_LLWEAPONEX_VendingMachine_Temp_SaleStarted(1);
DB_LLWEAPONEX_VendingMachine_Temp_GenerationTickDone(1);
ProcObjectTimer(_VendingMachine, "LLWEAPONEX_Timers_VendingMachine_SaleStarted", 1000);

IF
DB_LLWEAPONEX_VendingMachine_Temp_SaleStarted(1)
AND
DB_IsPlayer(_Player)
THEN
CharacterAddAttitudeTowardsPlayer(CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, _Player, 100);

PROC
ProcObjectTimerFinished((CHARACTERGUID)_VendingMachine, "LLWEAPONEX_Timers_VendingMachine_SaleStarted")
AND
DB_LLWEAPONEX_VendingMachine_Temp_SaleStarted(1)
THEN
NOT DB_LLWEAPONEX_VendingMachine_Temp_SaleStarted(1);

//Sale countdown
PROC
LLWEAPONEX_VendingMachine_OnTradeGenerationEnded((CHARACTERGUID)_VendingMachine)
AND
NOT DB_LLWEAPONEX_VendingMachine_Temp_GenerationTickDone(_)
AND
NOT DB_LLWEAPONEX_VendingMachine_Temp_SaleJustDecreased(_)
AND
DB_LLWEAPONEX_VendingMachine_SaleCooldown(_ActiveTime, _CooldownTime)
AND
_ActiveTime > 0
AND
IntegerSubtract(_ActiveTime, 1, _NextActiveTime)
AND
IntegertoString(_NextActiveTime, _NextActiveTimeStr)
THEN
LeaderLog_Log("DEBUG", "[LLWEAPONEX:VendingMachine:TradeGenerationEnded] Sale time decreased. Remaining events: [",_NextActiveTimeStr,"]");
NOT DB_LLWEAPONEX_VendingMachine_SaleCooldown(_ActiveTime, _CooldownTime);
DB_LLWEAPONEX_VendingMachine_SaleCooldown(_NextActiveTime, _CooldownTime);
DB_LLWEAPONEX_VendingMachine_Temp_SaleJustDecreased(1);
DB_LLWEAPONEX_VendingMachine_Temp_GenerationTickDone(1);
ProcObjectTimer(_VendingMachine, "LLWEAPONEX_Timers_VendingMachine_ResetSaleDecreased", 10000);

PROC
ProcObjectTimerFinished((CHARACTERGUID)_VendingMachine, "LLWEAPONEX_Timers_VendingMachine_ResetSaleDecreased")
AND
DB_LLWEAPONEX_VendingMachine_Temp_SaleJustDecreased(1)
THEN
NOT DB_LLWEAPONEX_VendingMachine_Temp_SaleJustDecreased(1);

//Sale Over
PROC
LLWEAPONEX_VendingMachine_OnTradeGenerationEnded((CHARACTERGUID)_VendingMachine)
AND
NOT DB_LLWEAPONEX_VendingMachine_Temp_GenerationTickDone(_)
AND
DB_LLWEAPONEX_VendingMachine_SaleCooldown(_ActiveTime, _CooldownTime)
AND
_ActiveTime == 0
THEN
NOT DB_LLWEAPONEX_VendingMachine_SaleCooldown(_ActiveTime, _CooldownTime);
DB_LLWEAPONEX_VendingMachine_SaleCooldown(-1, _CooldownTime);
DB_LLWEAPONEX_VendingMachine_Temp_GenerationTickDone(1);
LLWEAPONEX_VendingMachine_OnSaleEnded(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a);

PROC
LLWEAPONEX_VendingMachine_OnTradeGenerationEnded((CHARACTERGUID)_VendingMachine)
AND
NOT DB_LLWEAPONEX_VendingMachine_Temp_GenerationTickDone(_)
AND
NOT DB_LLWEAPONEX_VendingMachine_Temp_SaleStarted(1)
AND
DB_LLWEAPONEX_VendingMachine_SaleCooldown(-1, _CooldownTime)
AND
_CooldownTime > 0
THEN
LLWEAPONEX_VendingMachine_DecrementSaleCooldown();
DB_LLWEAPONEX_VendingMachine_Temp_GenerationTickDone(1);

PROC
LLWEAPONEX_VendingMachine_OnTradeGenerationEnded((CHARACTERGUID)_VendingMachine)
AND
DB_LLWEAPONEX_VendingMachine_Temp_GenerationTickDone(_Var)
THEN
NOT DB_LLWEAPONEX_VendingMachine_Temp_GenerationTickDone(_Var);

PROC
LLWEAPONEX_VendingMachine_DecrementSaleCooldown()
AND
DB_LLWEAPONEX_VendingMachine_SaleCooldown(-1, _CooldownTime)
AND
IntegerSubtract(_CooldownTime, 1, _NextCooldownTime)
THEN
NOT DB_LLWEAPONEX_VendingMachine_SaleCooldown(-1, _CooldownTime);
DB_LLWEAPONEX_VendingMachine_SaleCooldown(-1, _NextCooldownTime);

IF
DB_LLWEAPONEX_VendingMachine_SaleCooldown(-1, _CooldownTime)
AND
_CooldownTime <= 0
THEN
LLWEAPONEX_VendingMachine_ClearSaleCooldown();

PROC
LLWEAPONEX_VendingMachine_ClearSaleCooldown()
AND
DB_LLWEAPONEX_VendingMachine_SaleCooldown(_Active, _CooldownTime)
THEN
NOT DB_LLWEAPONEX_VendingMachine_SaleCooldown(_Active, _CooldownTime);

PROC
LLWEAPONEX_VendingMachine_ClearSaleCooldown()
AND
DB_LLWEAPONEX_VendingMachine_Temp_SaleStarted(1)
THEN
NOT DB_LLWEAPONEX_VendingMachine_Temp_SaleStarted(1);

PROC
LLWEAPONEX_VendingMachine_ClearSaleCooldown()
AND
DB_LLWEAPONEX_VendingMachine_Temp_SaleJustDecreased(1)
THEN
NOT DB_LLWEAPONEX_VendingMachine_Temp_SaleJustDecreased(1);

PROC
LLWEAPONEX_VendingMachine_ResetSaleAttitude()
AND
DB_IsPlayer(_Player)
AND
CharacterGetAttitudeTowardsPlayer(CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, _Player, _Attitude)
AND
_Attitude > 0
AND
IntegerProduct(_Attitude, -1, _RemoveAmount)
THEN
CharacterAddAttitudeTowardsPlayer(CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, _Player, _RemoveAmount);

IF
CharacterAttitudeTowardsPlayerChanged(CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, _Player, _NewAttitude)
AND
_NewAttitude < 0
AND
IntegerProduct(_NewAttitude, -1, _AddAmount)
THEN
CharacterAddAttitudeTowardsPlayer(CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, _Player, _AddAmount);

//Prevent "bribing" a machine
IF
DB_AttitudeAdjustMent(_Player, CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, _Att)
AND
_Att != 0
THEN
NOT DB_AttitudeAdjustMent(_Player, CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, _Att);
DB_AttitudeAdjustMent(_Player, CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, 0);

//Prevent "insulting" a machine
IF
DB_InsultCounter(_Player, CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, _InsultCount)
AND
_InsultCount > 0
THEN
NOT DB_InsultCounter(_Player, CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, _InsultCount);
DB_InsultCounter(_Player, CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, 0);
//END_REGION

//REGION RESET

IF
RegionEnded(_)
AND
ObjectExists(CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, 1)
THEN
ObjectClearFlag(CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LLWEAPONEX_Vending_Initialized");

IF
ObjectFlagCleared("LLWEAPONEX_Vending_Initialized", CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, _)
THEN
LLWEAPONEX_VendingMachine_ClearSaleCooldown();

/*
IF
StoryEvent(_VendingMachine, "LLWEAPONEX_VendingMachine_StartLoopEffects")
AND
DB_CurrentLevel(_Region)
THEN
PROC_LoopEffect("LLWEAPONEX_VendingMachine_A_PipeSmoke_01", _VendingMachine, "LLWEAPONEX_FX_VendingMachine_Smoke", _Region, "Dummy_SmokeFX");
PROC_LoopEffect("LLWEAPONEX_VendingMachine_WeaponDisplay_Quarterstaff_01", _VendingMachine, "LLWEAPONEX_FX_VendingMachine_WeaponDisplay_Hook", _Region, "Dummy_WeaponDisplay_Hook");
PROC_LoopEffect("LLWEAPONEX_VendingMachine_WeaponDisplay_ThrowingWeapons_01", _VendingMachine, "LLWEAPONEX_FX_VendingMachine_WeaponDisplay_Bottom", _Region, "Dummy_WeaponDisplay_Bottom");
LeaderLog_Log("DEBUG", "[LLWEAPONEX:VendingMachine:StartLoopEffects] Starting looped effects on vending machine.");
*/

//END_REGION

//REGION ANIMATIONS
IF
TextEventSet("llweap_vendtop")
THEN
CharacterUseSkill(CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "Shout_LLWEAPONEX_VendingMachine_Move_Top", CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a,0,1,1);

IF
CharacterUsedSkill(_VendingMachine, "Shout_LLWEAPONEX_VendingMachine_Move_Top", _, _)
AND
DB_CurrentLevel(_Level)
THEN
//PROC_LoopBeamEffect((STRING)_effect, (GUIDSTRING)_Source,(GUIDSTRING)_Target,(STRING)_SrcBone,(STRING)_TargetBone,(STRING)_ID,(STRING)_Region)
PROC_LoopBeamEffect("RS3_FX_GP_Beams_Telekinesis_01", _VendingMachine, _VendingMachine, "Dummy_BeamFX", "Dummy_WeaponDisplay_Top", "LLWEAPONEX_VendingMachine_TopItemMovement", _Level);

IF
SkillCast(_VendingMachine, "Shout_LLWEAPONEX_VendingMachine_Move_Top", _, _)
THEN
PROC_StopLoopBeamEffect(_VendingMachine, "LLWEAPONEX_VendingMachine_TopItemMovement");

IF
TextEventSet("llweap_vendmiddle")
THEN
CharacterUseSkill(CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "Shout_LLWEAPONEX_VendingMachine_Move_Middle", CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a,0,1,1);

IF
CharacterUsedSkill(_VendingMachine, "Shout_LLWEAPONEX_VendingMachine_Move_Middle", _, _)
AND
DB_CurrentLevel(_Level)
THEN
//PROC_LoopBeamEffect((STRING)_effect, (GUIDSTRING)_Source,(GUIDSTRING)_Target,(STRING)_SrcBone,(STRING)_TargetBone,(STRING)_ID,(STRING)_Region)
PROC_LoopBeamEffect("RS3_FX_GP_Beams_Telekinesis_01", _VendingMachine, _VendingMachine, "Dummy_BeamFX", "Dummy_WeaponDisplay_Top", "LLWEAPONEX_VendingMachine_TopItemMovement", _Level);

IF
SkillCast(_VendingMachine, "Shout_LLWEAPONEX_VendingMachine_Move_Top", _, _)
THEN
PROC_StopLoopBeamEffect(_VendingMachine, "LLWEAPONEX_VendingMachine_TopItemMovement");

IF
TextEventSet("llweap_vendtest")
AND
GetTextEventParamString(1, _Anim)
THEN
PlayAnimation(CHARACTERGUID_S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, _Anim, "");
//END_REGION

EXITSECTION

ENDEXITSECTION
ParentTargetEdge "LaughingLeader_WeaponExpansion"
