Version 1
SubGoalCombiner SGC_AND
INITSECTION

KBSECTION

IF
CharacterStatusApplied(_Character, "UNSHEATHED", _)
AND
ObjectGetFlag(_Character, "LLWEAPONEX_GrimoireOpened", 1)
THEN
LeaderLib_CancelObjectTimerByEvent(_Character, "LLWEAPONEX_Events_GrimoireFired");
ObjectClearFlag(_Character, "LLWEAPONEX_GrimoireOpened", 0);

IF
CharacterStatusApplied(_Character, "UNSHEATHED", _)
AND
NOT DB_Illusionist(_Character, _)
AND
DB_LLWEAPONEX_Grimoire_ActiveGrimoire(_Character, _Item, _Template)
THEN
LLWEAPONEX_Grimoire_QueueStateChange(_Character, _Item, _Template, 1);

IF
CharacterStatusRemoved(_Character, "UNSHEATHED", _)
AND
NOT DB_Illusionist(_Character, _)
AND
DB_LLWEAPONEX_Grimoire_ActiveGrimoire(_Character, _Item, _Template)
THEN
LLWEAPONEX_Grimoire_QueueStateChange(_Character, _Item, _Template, 0);

//Respec started, delete effects
IF
DB_Illusionist(_Player,_Mirror)
AND
DB_LLWEAPONEX_Grimoire_ActiveGrimoire(_Character, _Item, _Template)
THEN
LLWEAPONEX_Grimoire_StopAllEffects_All(_Character);

//Respec finished, play effects again
PROC
Proc_HomesteadTeleportAfterMirror((CHARACTERGUID)_Player,(ITEMGUID)_Mirror,(TRIGGERGUID)_Trigger)
AND
DB_LLWEAPONEX_Grimoire_ActiveGrimoire(_Character, _Item, _Template)
AND
CharacterIsInFightMode(_Player, _Unsheathed)
THEN
LLWEAPONEX_Grimoire_QueueStateChange(_Character, _Item, _Template, _Unsheathed);
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "LLWEAPONEX_80_ToggledScripts"